"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var s=0;s<e.length;s++){var a=e[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,s){return e&&_defineProperties(t.prototype,e),s&&_defineProperties(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}!function(c){new(function(){function t(){if(_classCallCheck(this,t),this.css_selector={},this.button_id="fkwcs_stripe_smart_button",this.payment_request=null,this.express_request_type=null,this.express_button_wrapper=null,this.is_product_page=!1,this.style_value=fkwcs_data.style,this.request_data={},this.fkCartRequestData={},this.fkCartExistingRequestData={},this.dataCommon={currency:fkwcs_data.currency,country:fkwcs_data.country_code,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0},""!==fkwcs_data.pub_key){try{this.stripe=Stripe(fkwcs_data.pub_key),this.init()}catch(t){"yes"===fkwcs_data.debug_log&&console.log("Stripe Error",t)}this.wcEvents()}}return _createClass(t,[{key:"init",value:function(){"yes"===fkwcs_data.is_product?this.request_data=Object.assign(this.dataCommon,{total:fkwcs_data.single_product.total,requestShipping:"1"===fkwcs_data.shipping_required,displayItems:fkwcs_data.single_product.displayItems}):"yes"===fkwcs_data.is_cart&&(this.request_data=Object.assign(this.dataCommon,{total:fkwcs_data.cart_data.order_data.total,requestShipping:"1"===fkwcs_data.shipping_required,displayItems:fkwcs_data.cart_data.displayItems})),this.setupPaymentRequest()}},{key:"ajaxEndpoint",value:function(t){var e="";return e=fkwcs_data.hasOwnProperty("wc_endpoints")&&fkwcs_data.wc_endpoints.hasOwnProperty(t)?fkwcs_data.wc_endpoints[t]:e}},{key:"setRequestData",value:function(t){t.hasOwnProperty("order_data")&&(this.request_data=Object.assign(this.dataCommon,{total:t.order_data.total,currency:t.order_data.currency,country:t.order_data.country_code,requestShipping:t.shipping_required,displayItems:t.order_data.displayItems}))}},{key:"getRequestData",value:function(){return this.request_data}},{key:"setupPaymentRequest",value:function(){var t=this.getRequestData();if(0!==Object.keys(t).length)try{var e=this.stripe.paymentRequest(t);this.createButton(e),this.productEvents(e),e.canMakePayment().then(this.makePayment.bind(this)).catch(this.makePaymentCatch.bind(this)),e.on("paymentmethod",this.onPaymentMethod.bind(this)),e.on("shippingaddresschange",this.shippingAddressChange.bind(this)),e.on("shippingoptionchange",this.shippingOptionChange.bind(this)),e.on("cancel",this.cancelPayment.bind(this))}catch(t){console.log(t)}}},{key:"productEvents",value:function(e){var s=this,t=(c(".fkwcs_smart_cart_button").off("click").on("click",function(t){e.show(),t.preventDefault()}),c(".fkwcs_smart_checkout_button").off("click").on("click",function(t){e.show(),t.preventDefault()}),c(".fkwcs_smart_product_button"));t.off("click").on("click",function(t){c(this).hasClass("fkwcs_disabled_btn")?alert("Please Select Options"):(e.show(),t.preventDefault(),c.when(s.addToCartProduct()))}),c(document.body).off("show_variation").on("show_variation",function(){t.removeClass("fkwcs_disabled_btn")}),c(document.body).off("hide_variation").on("hide_variation",function(){t.addClass("fkwcs_disabled_btn")}),c(document.body).off("woocommerce_variation_has_changed").on("woocommerce_variation_has_changed",function(){s.updateSelectedProductsData(e)}),c("form.cart .quantity").off("input").on("input",".qty",function(){s.updateSelectedProductsData(e)})}},{key:"updateSelectedProductsData",value:function(e){c.when(this.prepareSelectedProductData()).then(function(t){t.error?self.showErrorMessage(t.error):c.when(e.update({total:t.total,displayItems:t.displayItems})).then(function(){})})}},{key:"createButton",value:function(t){var e=this.stripe.elements();this.stripe_button=e.create("paymentRequestButton",{paymentRequest:t})}},{key:"makePayment",value:function(t){var e=c(".fkwcs_smart_buttons");if(t){var s=c(".fkwcs_express_checkout_button_icon"),a=c(".fkwcs_stripe_smart_button_wrapper"),n=c("#fkwcs-payment-request-separator"),i="";if(t.applePay)this.express_request_type="apple_pay",this.express_button_wrapper="fkwcs_ec_applepay_button",i="dark"===fkwcs_data.style.theme?fkwcs_data.icons.applepay_light:fkwcs_data.icons.applepay_gray;else{if(!t.googlePay)return void e.hide();this.express_request_type="google_pay",this.express_button_wrapper="fkwcs_ec_googlepay_button",i="dark"===fkwcs_data.style.theme?fkwcs_data.icons.gpay_light:fkwcs_data.icons.gpay_gray}this.makeButtonVisibleInline(),this.buttonOnProductPage(),this.buttonOnCartPage(),this.buttonOnCheckoutPage(),s.hide(),e.addClass("fkwcs_express_"+this.express_request_type),e.removeClass("fkwcs_ec_payment_button-"+fkwcs_data.style.theme),e.addClass(this.express_button_wrapper+"-"+fkwcs_data.style.theme),""!==i&&(s.attr("src",i),s.show()),n.hasClass("cart")&&n.show(),n.hasClass("checkout")&&n.show(),!n.hasClass("fkwcs-product")||a.hasClass("inline")||n.show(),a.length&&(a.css("display","block"),c(document.body).trigger("fkwcs_smart_buttons_showed",["stripe"])),"inline"===fkwcs_data.style.button_position&&a.hasClass("fkwcs-product")&&(document.getElementById("fkwcs_stripe_smart_button_wrapper").style.display="inline-block")}else"yes"===fkwcs_data.debug_log&&(console.log(fkwcs_data.debug_msg),e.hide())}},{key:"onPaymentMethod",value:function(e){var s=this,t=this.paymentMethodData(e);c.ajax({type:"POST",data:t,dataType:"json",url:this.ajaxEndpoint("wc_stripe_create_order"),success:function(t){"success"===t.result?!1===s.confirmPaymentIntent(e,t.redirect)&&(window.location=t.redirect):s.abortPayment(e,t.messages)}})}},{key:"addToCartProduct",value:function(){var t=c(".single_add_to_cart_button").val(),e=c(".single_variation_wrap"),e=(e.length&&(t=e.find('input[name="product_id"]').val()),c(".quantity .qty").val()),a={fkwcs_nonce:fkwcs_data.fkwcs_nonce,action:"add_to_cart",product_id:t,qty:e,attributes:c(".variations_form").length?this.getVariationAttributes().attributes:[]},t=c("form.cart").serializeArray();return c.each(t,function(t,e){var s;/^addon-/.test(e.name)?/\[\]$/.test(e.name)?(s=e.name.substring(0,e.name.length-2),a[s]?a[s].push(e.value):a[s]=[e.value]):a[e.name]=e.value:/^fkwcs_plan_/.test(e.name)&&(a[e.name]=e.value)}),c.ajax({type:"POST",data:a,url:this.ajaxEndpoint("fkwcs_add_to_cart")})}},{key:"prepareSelectedProductData",value:function(){var t=c(".single_variation_wrap"),e=c(".single_add_to_cart_button").val(),t=(0<t.length&&(e=c(".single_variation_wrap").find('input[name="product_id"]').val()),c("#product-addons-total")),s=0,t=(0<t.length&&(s=(t.data("price_data")||[]).reduce(function(t,e){return t+e.cost},0)),{fkwcs_nonce:fkwcs_data.fkwcs_nonce,product_id:e,qty:c(".quantity .qty").val(),addon_value:s,attributes:c(".variations_form").length?this.getVariationAttributes().attributes:[]});return c.ajax({type:"POST",data:t,url:this.ajaxEndpoint("fkwcs_selected_product_data")})}},{key:"logError",value:function(t){c.ajax({type:"POST",url:fkwcs_data.admin_ajax,data:{action:"fkwcs_js_errors",_security:fkwcs_data.js_nonce,failed:2<arguments.length&&void 0!==arguments[2]&&arguments[2],error:t}})}},{key:"getVariationAttributes",value:function(){var t=c(".variations_form").find(".variations select"),e={},s=0;return t.each(function(){var t=c(this).data("attribute_name")||c(this).attr("name");e[t]=c(this).val()||"",s++}),{count:s,chosenCount:0,attributes:e}}},{key:"paymentMethodData",value:function(t){var e=t.paymentMethod,s=e.billing_details,a=s.email,n=s.phone,i=s.address,s=s.name,r=t.shippingAddress,o={fkwcs_nonce:fkwcs_data.fkwcs_nonce,billing_first_name:null!==s?s.split(" ").slice(0,1).join(" "):"test",billing_last_name:null!==s?s.split(" ").slice(1).join(" "):"test",billing_company:"",billing_email:null!==a?a:t.payerEmail,billing_phone:null!==n?n:t.payerPhone&&t.payerPhone.replace("/[() -]/g",""),order_comments:"",payment_method:"fkwcs_stripe",terms:1,fkwcs_source:e.id,payment_request_type:this.express_request_type},o=this.prepareBillingAddress(o,i);return o=this.prepareShippingAddress(o,r),fkwcs_data.is_checkout?(null!==t.shippingOption&&c('input[name="shipping_method[0]"][value="'+t.shippingOption.id+'"]').prop("checked",!0),s=c("form[name=checkout]").serializeArray(),c.each(s,function(t,e){!1!==Object.prototype.hasOwnProperty.call(o,e.name)&&""!==o[e.name]||(o[e.name]=e.value)}),o.page_from="checkout"):"yes"===fkwcs_data.is_product?o.page_from="product":o.page_from="cart",!0===Object.prototype.hasOwnProperty.call(o,"wc-fkwcs_stripe-payment-token")&&delete o["wc-fkwcs_stripe-payment-token"],o=JSON.parse(JSON.stringify(o))}},{key:"prepareBillingAddress",value:function(t,e){return t.billing_country=null!==e?e.country:"",t.billing_address_1=null!==e?e.line1:"",t.billing_address_2=null!==e?e.line2:"",t.billing_city=null!==e?e.city:"",t.billing_state=null!==e?e.state:"",t.billing_postcode=null!==e?e.postal_code:"",t}},{key:"prepareShippingAddress",value:function(t,e){return e&&(t.shipping_first_name=e.recipient.split(" ").slice(0,1).join(" "),t.shipping_last_name=e.recipient.split(" ").slice(1).join(" "),t.shipping_company=e.organization,t.shipping_country=e.country,t.shipping_address_1=void 0===e.addressLine[0]?"":e.addressLine[0],t.shipping_address_2=void 0===e.addressLine[1]?"":e.addressLine[1],t.shipping_city=e.city,t.shipping_state=e.region,t.shipping_postcode=e.postalCode,t.ship_to_different_address=1),t}},{key:"confirmPaymentIntent",value:function(t,e){e=e.match(/^#?fkwcs-confirm-(pi|si)-([^:]+):(.+)$/);if(!e||e.length<4)return!1;var s=e[1],a=e[2],e=decodeURIComponent(e[3]);this.confirmPayment(t,a,e,s)}},{key:"confirmPayment",value:function(e,t,s,a){var n=this;("si"==a?this.stripe.handleCardSetup(t,{}):this.stripe.confirmCardPayment(t,{})).then(function(t){t.error?(n.logError(t.error),c(".woocommerce-error").remove(),c("form.woocommerce-checkout").unblock(),c(".woocommerce-notices-wrapper:first-child").html('<div class="woocommerce-error fkwcs-errors">'+t.error.message+"</div>").show()):"requires_capture"!==(t=t["si"===a?"setupIntent":"paymentIntent"]).status&&"succeeded"!==t.status||(e.complete("success"),c("form.woocommerce-checkout").addClass("processing"),c("form.woocommerce-checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),window.location=s)})}},{key:"abortPayment",value:function(t,e){t.complete("fail"),this.showErrorMessage(e)}},{key:"shippingAddressChange",value:function(e){var t=e.shippingAddress,t={fkwcs_nonce:fkwcs_data.fkwcs_nonce,country:t.country,state:t.region,postcode:t.postalCode,city:t.city,address:void 0===t.addressLine[0]?"":t.addressLine[0],address_2:void 0===t.addressLine[1]?"":t.addressLine[1],payment_request_type:this.express_request_type,is_product_page:this.is_product_page};return c.ajax({type:"POST",data:t,url:this.ajaxEndpoint("fkwcs_update_shipping_address"),success:function(t){"success"===t.result?e.updateWith({status:t.result,total:t.total,shippingOptions:t.shipping_methods,displayItems:t.displayItems}):"fail"===t.result&&e.updateWith({status:"fail"})}})}},{key:"shippingOptionChange",value:function(e){var t=e.shippingOption,t={fkwcs_nonce:fkwcs_data.fkwcs_nonce,shipping_method:[t.id],payment_request_type:this.express_request_type,is_product_page:this.is_product_page};return c.ajax({type:"POST",data:t,url:this.ajaxEndpoint("fkwcs_update_shipping_option"),success:function(t){"success"===t.result&&e.updateWith({status:"success",total:t.total,displayItems:t.displayItems}),"fail"===t.result&&e.updateWith({status:"fail"})}})}},{key:"makePaymentCatch",value:function(t){console.log(t)}},{key:"cancelPayment",value:function(){c(document.body).trigger("fkwcs_express_cancel_payment",this)}},{key:"showErrorMessage",value:function(t){c(".woocommerce-error").remove(),("no"!==fkwcs_data.is_product?c(".product").first():c("form.checkout").closest("form")).before(t),window.scrollTo({top:100,behavior:"smooth"})}},{key:"getCartDetails",value:function(){var t={fkwcs_nonce:fkwcs_data.fkwcs_nonce},e=this;c.ajax({type:"POST",data:t,url:this.ajaxEndpoint("fkwcs_get_cart_details"),success:function(t){t.success&&(e.setRequestData(t.data),e.setupPaymentRequest())}})}},{key:"wcEvents",value:function(){var a=this,s=this;c(document.body).on("updated_checkout",function(t,e){e&&e.fragments&&(s.setRequestData(e.fragments.fkwcs_cart_details),s.setupPaymentRequest())}),c(document.body).on("updated_cart_totals",function(){s.getCartDetails()}),c(document.body).on("wc_fragments_refreshed added_to_cart removed_from_cart",function(){setTimeout(function(){if("undefined"==typeof wc_cart_fragments_params)return!1;var t;"undefined"!=typeof Storage&&"yes"!==fkwcs_data.is_product&&(t=sessionStorage.getItem(wc_cart_fragments_params.fragment_name),"object"==_typeof(t=JSON.parse(t)))&&(s.setRequestData(t.fkwcs_cart_details),s.setupPaymentRequest())},300)}),c(document.body).on("fkwcs_express_button_init",function(){a.setupPaymentRequest()}),"yes"===fkwcs_data.is_product&&(c(document.body).on("fkcart-open",function(){a.fkCartExistingRequestData=JSON.stringify(a.getRequestData()),a.setRequestData(a.fkCartRequestData),a.setupPaymentRequest()}),c(document.body).on("fkcart-close",function(){var t=JSON.parse(a.fkCartExistingRequestData);t.hasOwnProperty("total")&&(a.request_data=t,a.setupPaymentRequest())})),c(document.body).on("fkcart_fragments_refreshed",function(t,e){var s=c("#fkcart-modal");void 0!==e&&e.hasOwnProperty("fkwcs_cart_details")&&(s.hasClass("fkcart-show")?(a.setRequestData(e.fkwcs_cart_details),a.setupPaymentRequest()):a.fkCartRequestData=e.fkwcs_cart_details)})}},{key:"setCss",value:function(t,e,s){this.css_selector.hasOwnProperty(t)||(this.css_selector[t]={}),this.css_selector[t][e]=s}},{key:"applyCss",value:function(){for(var t in this.css_selector)if(0!==Object.keys(this.css_selector[t]).length)for(var e in this.css_selector[t])c(t).css(e,this.css_selector[t][e])}},{key:"buttonOnProductPage",value:function(){var t,e,s,a,n;1==fkwcs_data.is_product_page&&0!==c("form.cart button.single_add_to_cart_button").length&&(t=c("form.cart button.single_add_to_cart_button:visible"),e=c(".fkwcs_smart_buttons"),s=10<this.style_value.button_length?"min-width":"width",a="px","above"===this.style_value.button_position?(this.setCss("#fkwcs_stripe_smart_button_wrapper","width","100%"),this.setCss("#fkwcs-payment-request-separator","width","200px"),this.setCss("form.cart button.single_add_to_cart_button",s,"200px"),this.setCss("form.cart button.single_add_to_cart_button","float","left"),this.setCss("form.cart","display","inline-block"),this.setCss(".fkwcs_smart_buttons",s,"200px")):(n=t.outerWidth()+c("form.cart .quantity").width()+parseInt(c("form.cart .quantity").css("marginRight").replace("px","")),"inline"===this.style_value.button_position?(n=(n=t.outerWidth())<120?150:n,c("form.cart").width()<500&&this.makeButtonVisibleInline(),this.setCss("form.cart button.single_add_to_cart_button",s,n+"px")):(this.setCss("form.grouped_form button.single_add_to_cart_button",s,n+"px"),0<c(".theme-kadence button.single_add_to_cart_button").length&&(this.setCss(".theme-kadence button.single_add_to_cart_button",s,(n=100)+(a="%")),this.setCss(".theme-kadence button.single_add_to_cart_button","margin-top","20px"))),this.setCss("#fkwcs_stripe_smart_button_wrapper",s,n+a),this.setCss("form.cart .fkwcs_smart_buttons",s,n+a),"below"===this.style_value.button_position&&(this.setCss(".theme-twentytwentytwo .fkwcs_smart_buttons",s,t.outerWidth()+"px"),this.setCss(".theme-twentytwentytwo #fkwcs-payment-request-separator",s,t.outerWidth()+"px"))),this.applyCss(),this.expressBtnStyle(e,t))}},{key:"buttonOnCartPage",value:function(){var t,e;"yes"==fkwcs_data.is_cart&&0!=c(".wc-proceed-to-checkout .checkout-button").length&&(t=c(".wc-proceed-to-checkout .checkout-button"),e=c(".fkwcs_smart_buttons"),30<c(".place-order #place_order").outerHeight()&&this.setCss(".fkwcs_smart_buttons","height",t.outerHeight()+"px"),this.setCss(".fkwcs_smart_buttons","font-size",t.css("font-size")),this.applyCss(),this.expressBtnStyle(e,t))}},{key:"buttonOnCheckoutPage",value:function(){var t=c(".woocommerce-billing-fields");"yes"==fkwcs_data.is_checkout&&0!=t.length&&(this.setCss("#fkwcs_stripe_smart_button_wrapper","max-width",t.outerWidth(!0)),this.applyCss())}},{key:"expressBtnStyle",value:function(s,a){c.each(["padding","border-radius","box-shadow","font-weight","text-shadow","font-size","line-height","padding"],function(t,e){s.css(e,a.css(e))}),s.css("max-height",a.outerHeight()+"px")}},{key:"makeButtonVisibleInline",value:function(){var t,e,s="",a=c("#fkwcs_stripe_smart_button_wrapper");0!=a.length&&(a.hasClass("inline")&&(t=(a=a.parent()).children(".single_add_to_cart_button"),e=a.children(".quantity"),s=a.outerWidth()-((a=t.outerWidth())+e.outerWidth()+10),this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","marginRight",e.css("marginRight")),a<s?(this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","margin",0),this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","marginRight",e.css("marginRight")),this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","clear","unset"),this.setCss("#fkwcs_stripe_smart_button_wrapper","margin","0px"),this.setCss("#fkwcs_stripe_smart_button_wrapper","display","inline-block")):(this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","margin","10px 0"),this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","flex","initial"),this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","clear","both"),this.setCss("#fkwcs_stripe_smart_button_wrapper .theme-flatsome .cart .quantity","width","100%"),this.setCss("#fkwcs_stripe_smart_button_wrapper .theme-flatsome .cart .quantity","clear","both"),this.setCss("#fkwcs_stripe_smart_button_wrapper","maringTop","10px"),this.setCss("#fkwcs_stripe_smart_button_wrapper","display","block")),60<(s=t.outerHeight())&&this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","height","60"),s<35&&this.setCss("#fkwcs_stripe_smart_button_wrapper .single_add_to_cart_button","height","35"),c("#fkwcs_stripe_smart_button_wrapper").width(a)),this.applyCss())}}]),t}())}(jQuery);